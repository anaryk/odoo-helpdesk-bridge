name: CI/CD Pipeline

on:
  push:
    branches: [ "main", "feat/**", "feature/**", "bugfix/**", "hotfix/**" ]
  pull_request:
    branches: [ "main" ]
  release:
    types: [ published ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  test:
    name: Test and Security Check
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.24.9'
        
    - name: Verify dependencies
      run: go mod verify
      
    - name: Build
      run: go build -v ./...
      
    - name: Run tests
      run: go test -v -race -coverprofile=coverage.out ./...
      
    - name: Upload coverage reports to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.out
        token: ${{ secrets.CODECOV_TOKEN }}
        
    - name: Run go vet
      run: go vet ./...
      
    - name: Install staticcheck
      run: go install honnef.co/go/tools/cmd/staticcheck@latest
      
    - name: Run staticcheck
      run: staticcheck ./...
      
    - name: Install golangci-lint
      run: |
        curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin v1.55.2
        
    - name: Run golangci-lint
      run: golangci-lint run
      
    - name: Check for memory leaks
      run: go test -memprofile=mem.prof -v ./...
      
    - name: Security scan with govulncheck
      run: |
        go install golang.org/x/vuln/cmd/govulncheck@latest
        govulncheck ./...

  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    permissions:
      contents: read
      packages: write
      
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch,suffix=-{{sha}}
          type=raw,value=latest,enable={{is_default_branch}}
          type=sha,prefix=main-
          
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  tag-build:
    name: Build and Push Tagged Release
    runs-on: ubuntu-latest
    needs: test
    if: startsWith(github.ref, 'refs/tags/')
    
    permissions:
      contents: read
      packages: write
      
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Extract metadata for tags
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=semver,pattern={{major}}
          type=ref,event=tag
          
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [test, tag-build]
    if: startsWith(github.ref, 'refs/tags/')
    
    permissions:
      contents: write
      packages: read
      
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.24.9'
        
    - name: Generate changelog
      id: changelog
      run: |
        # Generate changelog from commits since last tag
        LAST_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
        if [ -n "$LAST_TAG" ]; then
          CHANGELOG=$(git log ${LAST_TAG}..HEAD --oneline --pretty=format:"* %s")
        else
          CHANGELOG=$(git log --oneline --pretty=format:"* %s")
        fi
        
        # Create changelog content
        cat > CHANGELOG.md << EOF
        # Changes in ${{ github.event.release.tag_name }}
        
        ${CHANGELOG}
        
        ## Docker Images
        
        Pull the Docker image:
        \`\`\`bash
        docker pull ghcr.io/${{ github.repository }}:${{ github.event.release.tag_name }}
        \`\`\`
        
        Or use latest:
        \`\`\`bash
        docker pull ghcr.io/${{ github.repository }}:latest
        \`\`\`
        
        ## Installation
        
        ### Using Docker
        
        1. Create config file based on \`config.yaml.example\`
        2. Run the container:
        \`\`\`bash
        docker run -v ./config.yaml:/app/config/config.yaml -v ./data:/app/data ghcr.io/${{ github.repository }}:${{ github.event.release.tag_name }}
        \`\`\`
        
        ### From Source
        
        1. Clone the repository
        2. Build: \`go build ./cmd/helpdesk-bridge\`
        3. Configure \`config.yaml\`
        4. Run: \`./helpdesk-bridge\`
        EOF
        
        echo "CHANGELOG_CONTENT<<EOF" >> $GITHUB_OUTPUT
        cat CHANGELOG.md >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
    - name: Build release binaries
      run: |
        mkdir -p dist
        
        # Build for different platforms
        GOOS=linux GOARCH=amd64 go build -o dist/helpdesk-bridge-linux-amd64 ./cmd/helpdesk-bridge
        GOOS=linux GOARCH=arm64 go build -o dist/helpdesk-bridge-linux-arm64 ./cmd/helpdesk-bridge
        GOOS=windows GOARCH=amd64 go build -o dist/helpdesk-bridge-windows-amd64.exe ./cmd/helpdesk-bridge
        GOOS=darwin GOARCH=amd64 go build -o dist/helpdesk-bridge-darwin-amd64 ./cmd/helpdesk-bridge
        GOOS=darwin GOARCH=arm64 go build -o dist/helpdesk-bridge-darwin-arm64 ./cmd/helpdesk-bridge
        
        # Create checksums
        cd dist
        sha256sum * > checksums.txt
        
    - name: Update release with binaries and changelog
      uses: softprops/action-gh-release@v1
      with:
        body: ${{ steps.changelog.outputs.CHANGELOG_CONTENT }}
        files: dist/*
        token: ${{ secrets.GITHUB_TOKEN }}